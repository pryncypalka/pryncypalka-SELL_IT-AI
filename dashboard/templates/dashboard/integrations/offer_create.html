
{% extends "dashboard/home.html" %}
{% load static %}
{% block extra_head %}
    <script defer src="{% static 'js/category_parameters.js' %}"></script>
{% endblock %}


{% block dashboard_content %}
<div class="container-fluid">
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Podstawowe informacje</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nazwa produktu</label>
                            <input type="text" class="form-control" name="name" maxlength="75" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Kategoria</label>
                            <select class="form-select" name="category.id" required>
                                <!-- Filled dynamically via API -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Parameters -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Parametry</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="addParameter">
                    Dodaj parametr
                </button>
            </div>
            <div class="card-body">
                <div id="parametersContainer">
                    <!-- Filled dynamically based on category -->
                </div>
            </div>
        </div>

        <!-- Selling Options -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Opcje sprzedaży</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Cena</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="sellingMode.price.amount" step="0.01" required>
                                <span class="input-group-text">PLN</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Ilość</label>
                            <input type="number" class="form-control" name="stock.available" min="1" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-select" name="sellingMode.format" required>
                                <option value="BUY_NOW">Kup teraz</option>
                                <option value="AUCTION">Aukcja</option>
                                <option value="ADVERTISEMENT">Reklama</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Obrazy</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="file" class="form-control" id="images" multiple accept="image/*">
                    <div id="imagePreview" class="mt-3 row g-2">
                        <!-- Image previews here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-4">
            <button type="button" class="btn btn-secondary me-2">Zapisz wersję roboczą</button>
            <button type="submit" class="btn btn-primary">Utwórz ofertę</button>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('[name="category.id"]');
    
    categorySelect.addEventListener('change', async function() {
        const categoryId = this.value;
        const parameters = await fetchCategoryParameters(categoryId);
        renderParameters(parameters);
    });

    async function fetchCategoryParameters(categoryId) {
        const response = await fetch(`/api/allegro/categories/${categoryId}/parameters`);
        return await response.json();
    }

    function renderParameters(parameters) {
        const container = document.getElementById('parametersContainer');
        container.innerHTML = parameters.map(param => `
            <div class="mb-3">
                <label class="form-label">${param.name}</label>
                <input type="text" 
                       class="form-control" 
                       name="parameters[${param.id}]"
                       ${param.required ? 'required' : ''}>
            </div>
        `).join('');
    }
});
</script>
{% endblock %}
{% endblock %}