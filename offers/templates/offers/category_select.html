<div class="category-select-wrapper">
    <input type="hidden" class="vTextField" name="{{ widget.name }}" id="{{ widget.attrs.id }}" value="{{ value}}" >

    <input type="text" id="category-name-display" value="{{selected_category}}" readonly>

    <button type="button" class="btn btn-primary mt-1" data-toggle="modal" data-target="#category-custom-modal">
        Wybierz kategorię
    </button>
</div>

{{ categories_data|json_script:"category-data" }}

<div class="modal fade" id="category-custom-modal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">Wybierz kategorię</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <button id="backButton" type="button" class="btn btn-secondary mb-3" style="display: none;">
                    Wróć
                </button>
                
                <div class="row" id="category-list"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>

<script>
    const categoryData = JSON.parse(document.getElementById('category-data').textContent);
    let categoryHistory = [];

    function renderCategories(categories) {
        const categoryList = document.getElementById('category-list');
        categoryList.innerHTML = '';  

        categories.forEach(category => {
            const card = document.createElement('div');
            card.classList.add('col-md-4', 'mb-3');
            
            const cardHtml = `
                <div class="card category-card">
                    <div class="card-body">
                        <h5 class="card-title">${category.name}</h5>
                        ${category.image ? `<img src="${category.image}" class="img-thumbnail" alt="${category.name}">` : ''}
                    </div>
                </div>
            `;
            
            card.innerHTML = cardHtml;
            
            card.querySelector('.card-body').addEventListener('click', () => {
                loadSubcategories(category.id, category.name, category.subcategories || []);
            });
            
            categoryList.appendChild(card);
        });

        document.getElementById('backButton').style.display = 
            categoryHistory.length > 0 ? 'block' : 'none';
    }

    function loadSubcategories(id, name, subcategories) {
        categoryHistory.push({ 
            id: id, 
            name: name, 
            subcategories: subcategories 
        });

        if (subcategories && subcategories.length > 0) {
            renderCategories(subcategories);
        } else {
            selectCategory(id, name);
        }
    }

    function selectCategory(id, name) {
        document.getElementById('category-name-display').value = name;
    
        document.getElementById('{{ widget.attrs.id }}').value = id;  
    
        $('#category-custom-modal').modal('hide');
        categoryHistory = [];
    }

    function goBack() {
        categoryHistory.pop();
        const previousCategory = categoryHistory[categoryHistory.length - 1];
        if (previousCategory) {
            renderCategories(previousCategory.subcategories);
        } else {
            renderCategories(categoryData);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderCategories(categoryData);
        document.getElementById('backButton').addEventListener('click', goBack);
    });
</script>